name: OpenAI Repo Bot

on:
  schedule:
    - cron: "0 6 * * *"   # run daily
  workflow_dispatch:       # manual trigger

jobs:
  repo-bot:
    name: AI Maintainer Bot
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install openai PyGithub

      - name: Run AI Maintainer
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python <<'EOF'
          import os, subprocess
          from pathlib import Path
          import openai
          from github import Github

          openai.api_key = os.getenv("OPENAI_API_KEY")
          gh = Github(os.getenv("GITHUB_TOKEN"))
          repo = gh.get_repo(os.getenv("GITHUB_REPOSITORY"))

          REQUIRED_FILES = {
              "CONTRIBUTING.md": "Write a professional contributing guide for a Python Flask + ML project with tests and MIT license.",
              "CODE_OF_CONDUCT.md": "Write a Contributor Covenant Code of Conduct for an open source project.",
              "LICENSE": "Generate an MIT License text."
          }

          repo_path = Path(".")

          def generate_file(name, prompt):
              response = openai.ChatCompletion.create(
                  model="gpt-3.5-turbo",
                  messages=[
                      {"role": "system", "content": "You are an expert open-source maintainer."},
                      {"role": "user", "content": prompt}
                  ]
              )
              content = response["choices"][0]["message"]["content"]
              with open(repo_path / name, "w") as f:
                  f.write(content.strip())
              print(f"âœ… Generated {name}")

          missing = []
          for file, prompt in REQUIRED_FILES.items():
              if not (repo_path / file).exists():
                  generate_file(file, prompt)
                  missing.append(file)

          if missing:
              # Configure git
              subprocess.run(["git", "config", "--global", "user.email", "bot@github.com"])
              subprocess.run(["git", "config", "--global", "user.name", "OpenAI Bot"])

              # Create new branch
              branch = "bot/docs-update"
              subprocess.run(["git", "checkout", "-b", branch])
              subprocess.run(["git", "add", "."])
              subprocess.run(["git", "commit", "-m", f"chore: add missing community files ({', '.join(missing)})"])
              subprocess.run(["git", "push", "origin", branch])

              # Create Pull Request
              pr_title = f"chore: add missing community files ({', '.join(missing)})"
              pr_body = f"This PR was automatically generated by the OpenAI Bot to add missing files: {', '.join(missing)}."
              repo.create_pull(title=pr_title, body=pr_body, head=branch, base="main")
              print("ðŸ“Œ Created PR branch with missing docs.")
          else:
              print("ðŸŽ‰ All required community files already exist.")
          EOF
